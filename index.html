<!DOCTYPE html>
<html lang="uz">

<head>
  <meta charset="UTF-8" />
  <title>Ombor boshqaruvi</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>ðŸ“¦ Ombor boshqaruvi</h1>

  <form id="product-form">
    <input type="hidden" id="edit-index" />
    <label>Kod: <input type="text" id="product-code" required /></label>
    <label>Nomi: <input type="text" id="product-name" required /></label>
    <label>Oâ€˜lcham (oâ€˜lchov birlikka qarab): <input type="number" id="product-size" step="0.001" min="0"
        required /></label>
    <label>Miqdor (dona yoki kg): <input type="number" id="product-quantity" step="0.001" min="0" required /></label>
    <label>Olish narxi (USD): <input type="number" id="product-cost-price-usd" step="0.01" min="0" /></label>
    <label>Sotish narxi (USD): <input type="number" id="product-sale-price-usd" step="0.01" min="0" /></label>
    <label>$ kursi: <input type="number" id="dollar-rate" value="12500" min="0" required /></label>
    <label>Kategoriya:
      <select id="product-category" required>
        <option value="luxury">Luxury</option>
        <option value="donali">Donali</option>
        <option value="pachkali">Pachkali</option>
        <option value="golden_art_floor">Golden Art Floor</option>
        <option value="kiloli">Kiloli</option>
      </select>
    </label>
    <button type="submit">âž• Saqlash</button>
  </form>

  <hr />

  <label>Kodni qidirish: <input type="text" id="search-code" placeholder="Kod..." /></label>
  <button id="save-sales-pdf">ðŸ“‘ Sotilganlarni PDF saqlash</button>

  <h2>Luxury va boshqa</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="luxury-table"></tbody>
  </table>
  <h2>Donali</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="donali-table"></tbody>
  </table>
  <h2>Pachkali</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="pachkali-table"></tbody>
  </table>
  <h2>Golden Art Floor</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="golden-art-floor-table"></tbody>
  </table>
  <h2>Kiloli</h2>
  <table>
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor (kg)</th>
        <th>Olish narxi</th>
        <th>Sotish narxi</th>
        <th>Amallar</th>
      </tr>
    </thead>
    <tbody id="kiloli-table"></tbody>
  </table>

  <h3 id="remain-summary"></h3>

  <hr />

  <h2>Sotuv</h2>
  <table>
    <thead>
      <tr>
        <th>Vaqt</th>
        <th>Kod</th>
        <th>Nomi</th>
        <th>Miqdor</th>
        <th>Soâ€˜m</th>
        <th>USD</th>
      </tr>
    </thead>
    <tbody id="sales-table"></tbody>
  </table>
  <p>Jami sotilgan: <span id="sold-total"></span>, <span id="sold-total-area"></span></p>

  <script>
    let products = JSON.parse(localStorage.getItem("products") || "[]"),
      sales = JSON.parse(localStorage.getItem("sales") || "[]");
    if (!Array.isArray(products)) products = [];
    if (!Array.isArray(sales)) sales = [];

    function fmtSom(v) {
      return v.toLocaleString("uz-UZ") + " soâ€˜m";
    }
    function fmtUsd(v) {
      return "$" + v.toFixed(2);
    }
    function roundQty(q) {
      const i = Math.floor(q), f = q - i;
      return f >= 0.5 ? Math.ceil(q) : Math.floor(q);
    }
    function getTableIdByCategory(cat) {
      return cat === "donali" ? "donali-table"
        : cat === "pachkali" ? "pachkali-table"
          : cat === "golden_art_floor" ? "golden-art-floor-table"
            : cat === "kiloli" ? "kiloli-table"
              : "luxury-table";
    }

    function renderProducts(filter = "") {
      ["luxury-table", "donali-table", "pachkali-table", "golden-art-floor-table", "kiloli-table"]
        .forEach(id => document.getElementById(id).innerHTML = "");

      products.forEach((p, i) => {
        if (filter && !p.code.toLowerCase().includes(filter.toLowerCase())) return;
        const tr = document.createElement("tr");
        let qtyDisplay;
        if (p.category === "kiloli") {
          qtyDisplay = p.quantity.toFixed(3) + " kg";
        } else {
          qtyDisplay = roundQty(p.quantity) + " dona (" + (p.totalArea || 0).toFixed(3) + " mÂ²)";
        }
        let actions = "";
        if (p.category === "kiloli") {
          actions += `<button onclick="sellByKg(${i})">Kiloda sotish</button>`;
          actions += `<button onclick="editProduct(${i})">Tahrirlash</button><button onclick="deleteProduct(${i})">Oâ€˜chirish</button>`;
        } else {
          if (!["donali", "pachkali"].includes(p.category)) actions += `<button onclick="sellByArea(${i})">Kvadrat sotish</button>`;
          actions += `<button onclick="sellByPiece(${i})">Dona sotish</button>`;
          actions += `<button onclick="editProduct(${i})">Tahrirlash</button><button onclick="deleteProduct(${i})">Oâ€˜chirish</button>`;
        }
        tr.innerHTML = `<td>${p.code}</td><td>${p.name}</td><td>${qtyDisplay}</td><td>${fmtSom(p.costSom)} / ${fmtUsd(p.costUsd)}</td><td>${fmtSom(p.saleSom)} / ${fmtUsd(p.saleUsd)}</td><td>${actions}</td>`;
        document.getElementById(getTableIdByCategory(p.category)).appendChild(tr);
      });

      renderRemain();
      renderSales();
    }

    function renderRemain() {
      let totalQ = 0, totalArea = 0;
      products.forEach(p => {
        totalQ += p.quantity;
        totalArea += p.totalArea || 0;
      });
      document.getElementById("remain-summary").textContent = `Omborda qolgan jami: ${totalQ.toFixed(3)} dona/kg, ${totalArea.toFixed(3)} mÂ²`;
    }

    function renderSales() {
      const tbl = document.getElementById("sales-table");
      tbl.innerHTML = "";
      let totalQty = 0, totalArea = 0;
      sales.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${s.time}</td><td>${s.code || ""}</td><td>${s.name}</td><td>${s.qty.toFixed(3)} ${s.unit}</td><td>${fmtSom(s.sumSom)}</td><td>${fmtUsd(s.sumUsd)}</td>`;
        tbl.appendChild(tr);
        totalQty += s.qty;
        totalArea += s.area || 0;
      });
      document.getElementById("sold-total").textContent = `${totalQty.toFixed(3)} dona/kg, ${totalArea.toFixed(3)} mÂ²`;
    }

    function addSale(code, name, qty, area, sumSom, sumUsd, unit) {
      const dt = new Date();
      const time = dt.toLocaleString("uz-UZ", { hour12: false });
      sales.push({ time, code, name, qty, area, sumSom, sumUsd, unit });
      localStorage.setItem("sales", JSON.stringify(sales));
    }

    // Sotish funksiyalari
    function sellByKg(idx) {
      const p = products[idx];
      let inp = prompt("Nechta kg sotiladi? (0.01â€“500)", "0.01");
      if (inp === null) return;
      const kg = parseFloat(inp);
      if (isNaN(kg) || kg < 0.01 || kg > 500) { alert("0.01â€“500 kg oraligâ€˜ida kiriting!"); return; }
      if (kg > p.quantity) { alert("Miqdor yetarli emas!"); return; }
      const unitSom = p.saleSom / p.quantity, unitUsd = p.saleUsd / p.quantity;
      p.quantity -= kg;
      if (p.quantity <= 0) products.splice(idx, 1);
      addSale(p.code, p.name, kg, 0, unitSom * kg, unitUsd * kg, "kg");
      localStorage.setItem("products", JSON.stringify(products));
      renderProducts();
      renderSales();
    }

    function sellByPiece(idx) {
      const p = products[idx];
      let q = prompt("Nechta dona sotiladi?", "1");
      if (q === null) return;
      const qty = parseFloat(q);
      if (isNaN(qty) || qty <= 0 || qty > p.quantity) {
        alert("Notoâ€˜gâ€˜ri miqdor!");
        return;
      }
      const area = (p.category === "donali" || p.category === "pachkali") ? 0 : qty * p.size;
      const unitSom = p.saleSom / p.quantity;
      const unitUsd = p.saleUsd / p.quantity;

      p.quantity -= qty;
      if (!["donali", "pachkali"].includes(p.category)) {
        p.totalArea -= area;
        if (p.quantity <= 0 || p.totalArea <= 0) products.splice(idx, 1);
      } else {
        if (p.quantity <= 0) products.splice(idx, 1);
      }

      addSale(p.code, p.name, qty, area, unitSom * qty, unitUsd * qty, "dona");
      localStorage.setItem("products", JSON.stringify(products));
      renderProducts();
      renderSales();
    }

    function sellByArea(idx) {
      const p = products[idx];
      let a = prompt("Necha mÂ² sotiladi?", "1");
      if (a === null) return;
      const area = parseFloat(a);
      if (isNaN(area) || area <= 0 || area > (p.totalArea || 0)) {
        alert("Notoâ€˜gâ€˜ri metr!");
        return;
      }
      const qty = area / p.size;
      const unitSom = p.saleSom / p.quantity;
      const unitUsd = p.saleUsd / p.quantity;
      p.quantity -= qty;
      p.totalArea -= area;
      if (p.quantity <= 0 || p.totalArea <= 0) products.splice(idx, 1);
      addSale(p.code, p.name, qty, area, unitSom * qty, unitUsd * qty, "mÂ²");
      localStorage.setItem("products", JSON.stringify(products));
      renderProducts();
      renderSales();
    }

    document.getElementById("search-code").addEventListener("input", function () {
      renderProducts(this.value);
    });

    document.getElementById("save-sales-pdf").addEventListener("click", function () {
      if (sales.length === 0) {
        alert("Sotilgan mahsulotlar yoâ€˜q!");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let y = 10;
      doc.setFontSize(16);
      doc.text("Sotilgan mahsulotlar", 10, y);
      y += 10;

      const headers = ["Vaqt", "Kod", "Nomi", "Miqdor", "Soâ€˜m", "USD"];
      doc.setFontSize(10);
      doc.text(headers.join(" | "), 10, y);
      y += 7;

      let totalSoldQty = 0, totalSoldArea = 0, totalSoldSom = 0, totalSoldUsd = 0;

      sales.forEach(s => {
        const row = [
          s.time,
          s.code,
          s.name,
          s.qty.toFixed(3) + " " + s.unit,
          fmtSom(s.sumSom),
          fmtUsd(s.sumUsd),
        ];
        doc.text(row.join(" | "), 10, y);
        y += 7;

        totalSoldQty += s.qty;
        totalSoldArea += s.area || 0;
        totalSoldSom += s.sumSom;
        totalSoldUsd += s.sumUsd;

        if (y > 280) {
          doc.addPage();
          y = 10;
        }
      });

      y += 10;
      doc.setFontSize(12);
      doc.text(`Jami sotilgan miqdor: ${totalSoldQty.toFixed(3)} dona/kg, ${totalSoldArea.toFixed(3)} mÂ²`, 10, y);
      y += 7;
      doc.text(`Jami sotilgan summa: ${fmtSom(totalSoldSom)}, ${fmtUsd(totalSoldUsd)}`, 10, y);

      doc.save("sotilganlar_hisobot.pdf");
    });

    renderProducts();
  </script>
</body>

</html>